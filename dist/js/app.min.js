/**
*	读书前端全局配置初始化js,进行一些全局的数据初始化工作
*/

(function(){
	console.log("初始化前端框架");

	//全局常量
	window.ebookweb = {
		config:{
			//api
			api_host:"http://book.rdtuijian.com/"
		},
		mediator:{},//主事件监听
		views:{
			//全部视图,其他模块组件,页面组件类统一存储到此包里面
			components:{
				//组件
			},
			pages:{
				//页面
			}
		},
		events:{
			//事件
			"GO_TO_MAIN_PAGE_EVENT":"goToMainPage",//去主页
			"CHANGE_MAIN_PAGE_TAB_EVENT":"changeMainPageTabEvent",//点击主页的标签事件,进行精选,排行榜,分类子页面的切换
			"POPUP_PAGE_EVENT":"popupPageEvent",//弹出一个新页面事件
			"REMOVE_PAGE_EVENT":"removePageEvent"//删除一个页面事件
		},
		utils:{
			Event://通用事件监听函数
			{
				// 绑定事件
				addEvent: function (element, type, handler) {
					if (element.addEventListener) {
						//事件类型、需要执行的函数、是否捕捉
						element.addEventListener(type, handler, false);
					} else if (element.attachEvent) {
						element.attachEvent('on' + type, handler);
					} else {
						element['on' + type] = handler;
					}
				},
				// 移除事件
				removeEvent: function (element, type, handler) {
					if (element.removeEventListener) {
						element.removeEventListener(type, handler, false);
					} else if (element.detachEvent) {
						element.detachEvent('on' + type, handler);
					} else {
						element['on' + type] = null;
					}
				},
				// 阻止事件 (主要是事件冒泡，因为IE不支持事件捕获)
				stopPropagation: function (ev) {
					if (ev.stopPropagation) {
						ev.stopPropagation();
					} else {
						ev.cancelBubble = true;
					}
				},
				// 取消事件的默认行为
				preventDefault: function (event) {
					if (event.preventDefault) {
						event.preventDefault();
					} else {
						event.returnValue = false;
					}
				}
			},
			Calculator://相关计算
			{
				delZero: function (numStr) {
					//如果小数位为0,则删除小数位
					numStr = String(Number(numStr).toFixed(1));

					if (numStr.indexOf('.0') > -1) {
						numStr = numStr.slice(0, -2);
					}

					return numStr;
				},
				fixedCount: function (wordCount) {
					//人数、阅读量超过999.9万，统一给出为999.9+万
					var resultStr;
					var NUMBER_LIMITATION = 999.9;

					wordCount = Number(wordCount);
					if ((wordCount < 10000)) {
						resultStr = this.delZero(wordCount);
					} else {
						wordCount = wordCount / 10000;
						if (wordCount >= NUMBER_LIMITATION) {
							resultStr = String(NUMBER_LIMITATION);
						} else {
							resultStr = this.delZero(wordCount);
						}
						resultStr = resultStr + '万';
					}

					return resultStr;
				},
				getDateDiff:function(dateTimeStamp) {
					var minute = 1000 * 60;
					var hour = minute * 60;
					var day = hour * 24;
					var halfamonth = day * 15;
					var month = day * 30;
					var now = new Date().getTime();
					var diffValue = now - dateTimeStamp;
					if(diffValue < 0){return;}
					var monthC =diffValue/month;
					var weekC =diffValue/(7*day);
					var dayC =diffValue/day;
					var hourC =diffValue/hour;
					var minC =diffValue/minute;
				
					if(hourC <= 1 && hourC > 0){
						result="[刚刚更新]";
					}else if(hourC <= 24){
						result="["+parseInt(hourC) + "小时前更新]"
					}else if(hourC > 24){
						result="["+this.getFormatTime(dateTimeStamp)+"更新]"
					}

					if(dayC >= 30){
						result = "";
					}


					return result;
				},
				getFormatTime: function(time) {
					var time = new Date(time);
					var y = time.getFullYear();
					var m = time.getMonth() + 1;
					var d = time.getDate();
					return y + '-' + this.add0(m) + '-' + this.add0(d);
				},
				add0:function(number){
					return number < 10 ? '0'+number : number;
				}
			},
			openBookWeb:function(url,mode)
			{
				//新的webview打开
				if(url.substr(0,4)!="http")
				{
					url=window.location.host+url;
				}

				console.log("openBookWeb:",url,mode);

				if(window.read&&window.read.jsOpenDefinedInterface&&mode=="webview") 
				{
					window.read.jsOpenDefinedInterface("readwebview", url);
					return false;
				}
				else
				{
					return true;
				}
			}
		},
		data:{
			//存储的数据
			GlobalData:{}//全局数据
		},
		models:{
			//数据对象
		}
	};

	_.extend(window.ebookweb.mediator,Backbone.Events)
})();
/**
*	读书前端统计js
*/

!function(e,n,t,s,a,c,r){e.KSOSieve=a,e[a]=e[a]||function(){(e[a].q=e[a].q||[]).push(arguments);
  },e[a].t=1*new Date,c=n.createElement(t),r=n.getElementsByTagName(t)[0],c.async=1,
  c.src=s,r.parentNode.insertBefore(c,r)}(window,document,"script","//ka.wpscdn.cn/ka.js","ka");

var StatMap = {
	'完本': 1,
	'连载': 2,
	MainPageClassesStatMap: {
		'言情': 'p4=2&p5=6&p6=4&p7=1',
		'都市': 'p4=2&p5=6&p6=4&p7=2',
		'玄幻': 'p4=2&p5=6&p6=4&p7=3',
		'仙侠': 'p4=2&p5=6&p6=4&p7=4',
		'穿越': 'p4=2&p5=6&p6=4&p7=5',

		'官场': 'p4=2&p5=6&p6=4&p7=6',
		'奇幻': 'p4=2&p5=6&p6=4&p7=7',
		'灵异': 'p4=2&p5=6&p6=4&p7=8',
		'武侠': 'p4=2&p5=6&p6=4&p7=9',
		'科幻': 'p4=2&p5=6&p6=4&p7=10',

		'历史': 'p4=2&p5=6&p6=4&p7=11',
		'游戏': 'p4=2&p5=6&p6=4&p7=12',
		'笑话': 'p4=2&p5=6&p6=4&p7=13',
		'校园': 'p4=2&p5=6&p6=4&p7=14',
		'军事': 'p4=2&p5=6&p6=4&p7=15'
  }
};

//统计函数
var Stat = {
	start:function(){
		//记录开始
		var tempArr = [];
		var p3 = 1;
		var info;
		var searchArr;

		//读取android webview的配置信息
		info = JSON.parse(window.read.jsGetDeviceInfo());
		searchArr = window.location.search.slice(1).split('&');
		$.each(searchArr, function (index, item) {
			tempArr = item.split('=');
			if (tempArr[0] === 'from') {
				p3 = tempArr[1];
				return false;
			}
		});

		info.app_version = info.app_version.replace(/\./g,'_');

		ka(
			'create',
			'dm=/wps/android/novel',
			'action=novel',
			'pnum=1',
			'p0=' + info.uid,
			'p1=' + info.channel,
			'p2=' + info.app_version,
			'p3=' + p3
		);

		console.log("stat start");
	},
	ka:function(){
		//监测
		console.log("arguments:",arguments);
		ka(arguments);
	}
};

if(!window.splash)
window.splash = {
	jsGetDeviceInfo:function(){
		var mockData = {
        uid: 'tao',
        channel: 'cn00999',
        app_version: '9.9.2'
      };
     return JSON.stringify(mockData);
	}
}

if (!window.read) {
  ka(
    'create',
    'dm=/wps/android/novel',
    'action=novel',
    'pnum=1'
  );

  window.read = {
    jsGetDeviceInfo: function () {
      var mockData = {
        uid: 'tao',
        channel: 'cn00999',
        app_version: '9.6.2'
      };
      return JSON.stringify(mockData);
    },
    jsGetDeviceInfo:function(){
    	var mockData2 = {
        uid: 'tao',
        channel: 'cn00999',
        app_version: '9.8.9'
      };
      return JSON.stringify(mockData2)
    }
  };
} else {
	Stat.start();
}
//app主数据对象
window.ebookweb.models.AppModel = Backbone.Model.extend({
	defaults:{

	}
});
//书item数据对象
window.ebookweb.models.BookItem = Backbone.Model.extend({
	defaults:{
		cateId: 0,
		imgUrl: "",
		url: "",
		isFromWeb: false,
		completed: "",
		catename: "",
		title: "",
		bookid: 0,
		author: "",
		readCount: 0,
		readCountFormated:0,
		wordCount: 0,
		score: 0,
		isContinue: 0,
		description: "",
		shortRecommend: "",
		bigCoverLogo: "",
		isfromweb: 0
	}
});

//书数据列表
window.ebookweb.models.BookList = Backbone.Collection.extend({
	model:window.ebookweb.models.BookItem
});
//item视图数据对象
window.ebookweb.models.ItemViewModel = Backbone.Model.extend({
	type:null,//item视图类型
	data:[]//数据对象
});
//一般页面数据对象
window.ebookweb.models.PageViewModel = Backbone.Model.extend({
	defaults:{
		title:"标题",
		pageid:"",
		data:null
	}
});
//搜索历史数据对象
window.ebookweb.models.SearchHistoryItem = Backbone.Model.extend({
	defaults:{
		keyword:"",
		value:""
	}
});

//搜索历史数据列表
window.ebookweb.models.SearchHistoryList = Backbone.Collection.extend({
	model:window.ebookweb.models.SearchHistoryItem,
	localStorage: new Backbone.LocalStorage("ebook-search-history"),
});
//主视图
window.ebookweb.views.AppView = Backbone.View.extend({
	el:"html",
	events:{
		"click window":"onBodyClick",
		"click .top-bar .music":"soundButtonHandler",
		"click .bottom-bar .arrow":"nextPage"
	},
	initialize:function(){
		//初始化
		window.ebookweb.mediator.on(window.ebookweb.events.CHANGE_MAIN_PAGE_TAB_EVENT,this.changeMainTabPageById,this);
		window.ebookweb.mediator.on(window.ebookweb.events.GO_TO_MAIN_PAGE_EVENT,this.goToMainPage,this);
		window.ebookweb.mediator.on(window.ebookweb.events.POPUP_PAGE_EVENT,this.onPopupPage,this);
		window.ebookweb.mediator.on(window.ebookweb.events.REMOVE_PAGE_EVENT,this.onRemovePage,this);

		this.container = this.$("body");//主页面容器

		this.pages = [];

		//禁止刷新
		if(window.read && window.read.JSSetSwipeRefreshEnabled) window.read.JSSetSwipeRefreshEnabled(false);

		//勿删，需要根据cookie中EBID查询用户对应最近阅读记录
		if (window.read && window.read.jsGetDeviceInfo) {
			this.info = JSON.parse(window.read.jsGetDeviceInfo());
			document.cookie = 'EBID=' + this.info.uid + ";path=/";
		}

		//loading加载页面
		this.curview = new window.ebookweb.views.pages.LoadingPageView({model:new window.ebookweb.models.PageViewModel({data:null})});
		this.container.append(this.curview.render().el);

		this.pages.push(this.curview);
	},
	onBodyClick:function(){

	},
	goToMainPage:function(){
		//去主页
		console.log("去主页");
		var self = this;
		if(this.curview != this.mainview)
		{
			if(!this.mainview)
			{
				this.mainview = new window.ebookweb.views.pages.MainPageView({model:new window.ebookweb.models.PageViewModel({data:null})});
				this.mainview.render(function(result){
					console.log("主页面回调");

					if(!_.isEmpty(result) && result["emphasis"])
					{
						self.curview.remove();//上一页面移除
						self.container.append(self.mainview.el);
						self.mainview.show();

						self.curview = self.mainview;
					}
					else
					{
						//显示错误提示
						console.log("网络异常");
						self.curview.$("p").html('<span style="color:#c4c4c4;font-size:0.45rem">网络异常<br>稍后再试</span>');
					}
				});
			}
			else
			{
				this.curview.destroy();//上一页面移除
				this.container.append(this.mainview.render().el);
				this.mainview.show();
				this.mainview.delegateEvents(this.mainview.events);//重新绑定事件

				this.curview = this.mainview;
			}
		}
	},
	changeMainTabPageById:function(tab){
		//修改主页的标签页面
		console.log("changeMainTabPageById:",tab);
		if(!this.mainview)
		{
			var self = this;
			this.mainview = new window.ebookweb.views.pages.MainPageView({model:new window.ebookweb.models.PageViewModel({data:null})});
			this.mainview.render(function(result){
				if(!_.isEmpty(result) && result["emphasis"])
				{
					if(self.curview) self.curview.remove();//上一页面移除
					self.container.append(self.mainview.el);
					self.mainview.show();

					self.curview = self.mainview;

					window.ebookweb.mediator.trigger(window.ebookweb.events.CHANGE_MAIN_PAGE_TAB_EVENT,tab);
				}
				else
				{
					//显示错误提示
					console.log("网络异常");
					self.curview.$("p").html("网络或数据接口异常");
				}
			});
		}
		else
		{
			if(this.curview == this.mainview) return;
			if(this.curview) this.curview.remove();//上一页面移除
			
			this.container.append(this.mainview.el);
			this.mainview.show();
			this.curview = this.mainview;

			// mediator.trigger(CHANGE_MAIN_PAGE_TAB_EVENT,tab);
		}
	},
	onPopupPage:function(page){
		//弹出一个新页面
		this.curview.destroy();//上一页面移除

		this.curview = page;
		this.container.append(this.curview.render().el);
		page.show();
	},
	onRemovePage:function(page){
		//删除一个页面
	}
});
//item基础视图
window.ebookweb.views.ItemBaseView = Backbone.View.extend({
	
});
//单页面基础视图
window.ebookweb.views.PageBaseView = Backbone.View.extend({
	tagName:"main",
	show:function(){
		
	},
	show1:function(animation){
		//显示
		var self = this;
		var animation = animation || "fadeIn";
		animation+=" animated";

		this.$el.addClass(animation).one(animation_end,function(){
			self.$el.removeClass(animation);
		});
	},
	destroy:function(){
		this.remove();
	},
	destroy1:function(animation){
		//删除
		var self = this;
		var animation = animation || "fadeOut";
		animation+=" animated";

		this.$el.addClass(animation).one(animation_end,function(){
			self.$el.removeClass(animation);
			self.remove();
		});
	}
});
//广告item视图
window.ebookweb.views.components.AdItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"a",
	className:"ad item-view",
	template:_.template($("#ad_item_view_template").html()),
	events:{
		//事件
		"click":"onClick"
	},
	initialize:function(){
		//初始化
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onClick:function(){
		console.log("点击广告位");

		ka(
			'info',
			'p4=2&p5=6&p6=5&p7=' + this.$(".content").html()
		);

		return true;
	}
});
//书列表item视图
window.ebookweb.views.components.BookListItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"li",
	className:"fig-word bd-bottom",
	template:_.template($("#book_list_item_view_template").html()),
	events:{
		//事件
		"click a":"onBookLinkClick"
	},
	initialize:function(){
		//初始化
		
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onBookLinkClick:function(e)
	{
		//书链接点击
		var p5 = this.model.get("stat_p5");

		console.log("书列表item点击,p5=",p5,e.currentTarget,this.model.toJSON());
		
		switch(p5)
		{
			case "5"://搜索结果页面
				ka(
					'info',
					'p4=2&p5=' + p5 +//统计的页面来源
					'&p6=1&p7=' + $(e.currentTarget).data("title") +
					'&p8=' + $(e.currentTarget).data("score")
				);
			break;
			case "14"://排行榜列表页面
			case "15":
			case "16":
			case "17":
			case "18":
			case "19":
				var p8 = ($(e.currentTarget).data("isfromweb") == "0" ?1:2);
				ka(
					'info',
					'p4=2&p5=' + p5 +//统计的页面来源
					'&p6=1&p7=' + this.model.get("stat_p7")+"&p8="+p8+"&p9="+StatMap[$(e.currentTarget).data("completed")]+"&p10="+$(e.currentTarget).data("title")
				);
			break;
			default://默认页面
				var isfromweb = $(e.currentTarget).data("isfromweb");
				isfromweb = (isfromweb=="1" ?1:2);
				ka(
					'info',
					'p4=2&p5=' + p5 +//统计的页面来源
					'&p6=1&p7=' + isfromweb +
					'&p8=' + StatMap[$(e.currentTarget).data("completed")] +
					'&p9=' + $(e.currentTarget).data("title") +
					'&p10=' + $(e.currentTarget).data("score")
				);
			break;
		}

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	}
});
//书列表视图
window.ebookweb.views.components.BookListView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"ul",
	template:_.template($("#book_list_view_template").html()),
	events:{
		//事件
	},
	initialize:function(){
		//初始化
		this.books = this.model.get("books") || new window.ebookweb.models.BookList();
		this.listenTo(this.books,"add",this.addBookItem);

		this.model.set({books:this.books});

		this.curpage = this.model.get("curpage") || 1;//当前页面
		this.isLoading = false;//是否正在加载
		this.hasMore = true;//是否还有更多
		this.stopAutoLoad = false;//是否停止自动加载
		this.isLoaded = false;//是否已经加载过书籍
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		this.container = this.$el;
		this.moreItem = this.$(".more-data");
		this.container.scrollTop(0);

		for(var i = 0;i<this.books.length;i++)
		{
			this.addBookItem(this.books.at(i));
		}

		var autoLoad = this.model.get("autoLoad") || false;
		if(!autoLoad)
		{
			//不自动加载
			console.log("不自动加载");
			// this.moreItem.hide();
			this.moreItem.css("background","none");
			this.moreItem.html("没有更多了");
		}
		else
		{
			this.moreItem.show();
			console.log("自动加载:",autoLoad);
			$(window).off("scroll");

			var self = this;
			setTimeout(function(){
				console.log("定时器加上滚动监听");
				$(window).on("scroll",self.onWindowScroll.bind(self));
			},500);
			// $(window).on("scroll",this.onWindowScroll.bind(this));
			if(!this.isLoaded) this.loadBooks();
		}

		this.moreItem.show();
		console.log("是否自动加载:",autoLoad,this.moreItem);

		console.log(this.model.toJSON());

		//监听相关页面事件,清除窗体滚动事件
		window.ebookweb.mediator.on(window.ebookweb.events.GO_TO_MAIN_PAGE_EVENT,this.destroy,this);
		window.ebookweb.mediator.on(window.ebookweb.events.POPUP_PAGE_EVENT,this.destroy,this);

		return this;
	},
	onWindowScroll:function(e){
		//滚动了
		var needLoad = ($(window).scrollTop() > this.container.height() - $(window).height() - 100);
		this.hasMore = true;
		if(needLoad && !this.isLoading && this.hasMore && !this.stopAutoLoad)
		{
			this.curpage++;
			this.model.set("curpage",this.curpage);
			this.loadBooks();
		}
	},
	loadBooks:function(){
		console.log("加载书籍");

		this.moreItem.show();

		this.isLoading = true;
		this.isLoaded = true;

		$.ajax({
			url:this.model.get("autoLoadURL"),
			method:"get",
			data:{
				page:this.curpage
			},
			dataType:"json",
			context:this
		}).always(function(result){
			console.log("loadBooks:",result);

			if(_.isArray(result) && !_.isEmpty(result))
			{
				this.addBooks(result);

				console.log("loadBooks size:",result.length);

				if(result.length<10)
				{
					this.moreItem.html("没有更多了");
				}
			}
			else if(result.code == 200 && _.isArray(result.data) && !_.isEmpty(result.data))
			{
				this.addBooks(result.data);

				if(result.data.length<=result.totalsize)
				{
					this.moreItem.html("没有更多了");
				}
			}
			else
			{
				this.hasMore = false;
				this.moreItem.html("没有更多了");
			}

			this.isLoading = false;
		});
	},
	addBookItem:function(data)
	{
		//添加了一本书
		var itemView = new window.ebookweb.views.components.BookListItemView({model:data});
		$(itemView.render().el).insertBefore(this.moreItem);
	},
	addBooks:function(list)
	{
		//添加一组书籍
		_.each(list,function(item,index){
			item["readCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(item["readCount"]);
			item["wordCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(item["wordCount"]);
			item["navtitle"] = this.model.get("title");

			var data = this.model.toJSON();
			data.data = item;

			this.books.add(new window.ebookweb.models.BookItem(data));
		},this);
	},
	destroy:function(){
		//销毁
		console.log("销毁booklist",this.$el.parent());
		$(window).off("scroll");
	}
});
//分类item视图
window.ebookweb.views.components.ClassesItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"ol",
	template:_.template($("#classes_item_view_template").html()),
	mapping: {
		'热门': 'cate0',
		'男频': 'cate1',
		'女频': 'cate2',
		'出版': 'cate3'
	},
	stats:{
		first:{
			'热门': '1',
			'男频': '2',
			'女频': '3',
			'出版': '4'
		},
		sub:{
			"言情":"1",
			"都市":"2",
			"玄幻":"3",
			"仙侠":"4",
			"穿越":"5",
			"官场":"6",
			"奇幻":"7",
			"灵异":"8",
			"武侠":"9",
			"科幻":"10",
			"历史":"11",
			"游戏":"12",
			"笑话":"13",
			"校园":"14",
			"军事":"15",
			"生活休闲":"16",
			"影视剧本":"17",
			"文学小说":"18",
			"文史传记":"19",
			"经管励志":"20",
			"社科科普":"21",
			"教育教辅":"22",
			"情感小说":"23",
			"灵异悬疑":"24",
		},
		p5:{
			"言情":"21",
			"都市":"22",
			"玄幻":"23",
			"仙侠":"24",
			"穿越":"25",
			"官场":"26",
			"奇幻":"27",
			"灵异":"28",
			"武侠":"29",
			"科幻":"30",
			"历史":"31",
			"游戏":"32",
			"笑话":"33",
			"校园":"34",
			"军事":"35",
			"生活休闲":"36",
			"影视剧本":"37",
			"文学小说":"38",
			"文史传记":"39",
			"经管励志":"40",
			"社科科普":"41",
			"教育教辅":"42",
			"情感小说":"43",
			"灵异悬疑":"44",
		},
		p6:{
			'热门':'3',
			"男频":"1",
			"女频":"2",
			'出版': '4'
		}
	},
	events:{
		//事件
		"click ul li a":"onClassLinkClick"
	},
	initialize:function(){
		//初始化
		var list = this.model.get("data");
		_.each(list,function(item,index){
			item["cateIconClass"] = this.mapping[item["cateClassName"]];

			_.each(item["cateList"],function(sub_item,sub_index){
				sub_item["stat_p5"] = this.stats["p5"][sub_item["cateName"]];
				sub_item["stat_p6"] = this.stats["p6"][item["cateClassName"]];
			},this);
		},this);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onClassLinkClick:function(e){
		//分类点击
		console.log("分类item点击:",e.currentTarget,"p6=",this.stats.sub[$(e.currentTarget).data("catename")],"p7=",this.stats.first[$(e.currentTarget).data("groupname")]);

		ka(
			'info',
			'p4=2&p5=20&p6=' + this.stats.sub[$(e.currentTarget).data("catename")] +'&p7=' + this.stats.first[$(e.currentTarget).data("groupname")]
		);

		return true;
	}
});
//分类导航item视图
window.ebookweb.views.components.EntrancesItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"section",
	className:"entrances item-view",
	attributes:{
	},
	template:_.template($("#entrances_item_view_template").html()),
	events:{
		//事件
		"click .first li a":"onClassNameClick",
		"click .second li a":"onRankNameClick"
	},
	initialize:function(){
		//初始化
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onClassNameClick:function(e){
		//分类点击
		console.log("分类点击",e.currentTarget);

		ka(
			'info',
			StatMap.MainPageClassesStatMap[$(e.currentTarget).data("catename")]
		);

		return true;
	}
});
//footer item视图
window.ebookweb.views.components.FooterItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"footer",
	className:"footer-right",
	template:_.template($("#footer_item_view_template").html()),
	events:{
		//事件
	},
	initialize:function(){
		//初始化
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	}
});
//免费item视图
window.ebookweb.views.components.FreeItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"ul",
	template:_.template($("#free_item_view_template").html()),
	events:{
		//事件
		"click li a":"onBookLinkClick"
	},
	initialize:function(){
		//初始化
		this.listenTo(this.model,"change",this.render);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		if(!this.model.get("data"))
		{
			//获取数据
			$.ajax({
				url:window.ebookweb.config.api_host+"free",
				method:"get",
				data:null,
				dataType:"json",
				context:this
			}).always(function(result){
				console.log("免费页数据:",result);

				if(result.data)
				{
					var startdate = Math.floor(new Date().getTime()/1000);
					this.model.set({leavetime:"限时免费：",startdate:startdate,expire:result.expire,data:result.data});

					//显示倒计时
					var self = this;
					this.freetime_interval = setInterval(function(){
						self.getFreeLeaveTime();
					},1000);
				}
			});
		}

		return this;
	},
	getFreeLeaveTime:function()
	{
		//计算剩余时间
		var startdate = Math.floor(new Date().getTime()/1000);
		var the_s=[this.model.get("expire")-startdate];
		var the_s_index = 0;

		// console.log("计算倒计时:",this.model.get("startdate"),this.model.get("expire"),the_s);

		if(the_s[the_s_index]>=0)
		{
			var the_D=Math.floor((the_s[the_s_index]/3600)/24) 
			var the_H=Math.floor((the_s[the_s_index]-the_D*24*3600)/3600); 
			var the_M=Math.floor((the_s[the_s_index]-the_D*24*3600-the_H*3600)/60); 
			var the_S=(the_s[the_s_index]-the_H*3600)%60; 
			html = "限时免费：剩余 "; 
			if(the_D!=0) html += the_D+"天";
			if(the_D!=0 || the_H!=0) html += '<span class="hour">'+(the_H)+"</span>小时"; 
			if(the_D!=0 || the_H!=0 || the_M!=0) html += '<span class="minute">'+the_M+"</span>分"; 
			html += '<span class="second">'+the_S+"</span>秒";

			// console.log(html);

			this.$(".time").html(html); 
			the_s[the_s_index]--;

			return html;
		}
		else
		{ 
			this.$(".time").html("已结束");

			return "已结束";
		} 
	},
	onBookLinkClick:function(e)
	{
		//书链接点击
		console.log("书籍点击",e.currentTarget);

		ka(
			'info',
			'p4=2&p5=48&p6=1&p7=' + (parseInt($(e.currentTarget).data("section"))+1) + '&p8=' + $(e.currentTarget).data("title")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	}
});
//热搜榜item视图
window.ebookweb.views.components.HotBookItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"section",
	className:"hot-book item-view",
	attributes:{
	},
	template:_.template($("#hot_book_item_view_template").html()),
	events:{
		//事件
		"click h3 a":"change",
		"click ul li a":"onBookLinkClick"//书籍点击
	},
	initialize:function(){
		//初始化
		this.listenTo(this.model,"change",this.render);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	change:function(){
		//换一批
		$.ajax({
			url:window.ebookweb.config.api_host+"hotBook",
			method:"get",
			data:null,
			dataType:"json",
			context:this
		}).always(function(result){
			//结果,目前返回是一个数据对象,之后加上错误码判断
			console.log(result);
			if(!_.isEmpty(result))
			{
				this.model.set({data:result});
			}
			else
			{
				alert("没有数据");
			}
		});

		ka(
			'info',
			'p4=2&p5=6&p6=7'
		);
	},
	onBookLinkClick:function(e){
		//点击搜索热词
		console.log("点击搜索热词",e.currentTarget);

		ka(
			'info',
			'p4=2&p5=6&p6=6&p7=' + $(e.currentTarget).data("title")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	}
});
//最近阅读item视图
window.ebookweb.views.components.LastReadItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"a",
	className:"last-read-item item-view",
	template:_.template($("#last_read_item_view_template").html()),
	events:{
		//事件
		"click":"onClick"
	},
	initialize:function(){
		//初始化
		this.listenTo(this.model,"change",this.render);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));
		this.$el.hide();

		return this;
	},
	onClick:function(){
		console.log("点击继续阅读");

		ka(
			'info',
			'p4=2&p5=6&p6=1'
		);

		var url = this.model.get("data")["url"];

		return window.ebookweb.utils.openBookWeb(url,"webview");
	}
});
//男生爱看item视图
window.ebookweb.views.components.ManItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"section",
	className:"like-see item-view top",
	attributes:{
	},
	template:_.template($("#man_item_view_template").html()),
	events:{
		//事件
		"click ol li a":"onBookLinkClick",
		"click .more a":"onMoreLinkClick"
	},
	initialize:function(){
		//初始化

		//转换数据
		var list = this.model.get("data");
		_.each(list,function(item,index){
			item["readCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(item["readCount"]);
		});
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onBookLinkClick:function(e)
	{
		//书链接点击
		console.log("男生爱看书籍点击",e.currentTarget);

		ka(
			'info',
			'p4=2&p5=6&p6=2&p7=3&p8=' + StatMap[$(e.currentTarget).data("completed")] + '&p9=' + $(e.currentTarget).data("title") + '&p10=' + $(e.currentTarget).data("bookid")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	},
	onMoreLinkClick:function()
	{
		console.log("点击更多");
		ka(
			'info',
			'p4=2&p5=6&p6=3&p7=4'
		);

		return true;
	}
});
//大分类导航item视图
window.ebookweb.views.components.NavsItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"nav",
	className:"circle-classes-nav item-view",
	template:_.template($("#navs_item_view_template").html()),
	events:{
		//事件
		"click ul li:eq(0) a":"onClassNameClick",
		"click ul li:eq(1) a":"onClassNameClick",
		"click ul li:eq(2) a":"onClassNameClick",
		"click ul li:eq(3) a":"onMoreNavItemClick"
	},
	mapping:
	{
		'奇幻': '0 0',
		'出版': '0 -40px',
		'都市': '0 -80px',
		'官场': '0 -120px',
		'军事': '0 -160px',

		'灵异': '0 -200px',
		'更多': '0 -240px',
		'其它': '0 -280px',
		'穿越': '0 -320px',
		'言情': '0 -360px',
		'武侠': '0 -400px',

		'仙侠': '0 -440px',
		'校园': '0 -480px',
		'玄幻': '0 -520px',
		'悬疑': '0 -560px',
		'影视': '0 -600px',
		'游戏': '0 -640px'
	},
	initialize:function(){
		//初始化

		//转换数据,根据分类设置对应的分类css
		_.each(this.model.get("data"),function(item,index){
			console.log(item,index);
			item["wordBackground"] = this.mapping[item["cateName"]];
		},this);

		console.log(this.model.toJSON());
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onClassNameClick:function(e){
		//分类点击
		console.log("分类点击",e.currentTarget);

		ka(
			'info',
			StatMap.MainPageClassesStatMap[$(e.currentTarget).data("catename")]
		);

		return true;
	},
	onMoreNavItemClick:function(){
		//点击更多按钮,今日分类列表页面
		console.log("more click");

		console.log("点击更多");
		ka(
			'info',
			'p4=2&p5=6&p6=3&p7=2'
		);

		window.ebookweb.mediator.trigger(window.ebookweb.events.CHANGE_MAIN_PAGE_TAB_EVENT,"class");
	}
});
//新书推荐item视图
window.ebookweb.views.components.NewBookItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"section",
	className:"item-view top",
	attributes:{
	},
	template:_.template($("#new_book_item_view_template").html()),
	events:{
		//事件
		"click ul figure a":"onBookLinkClick",
		"click .more a":"onMoreLinkClick"
	},
	initialize:function(){
		//初始化
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onBookLinkClick:function(e)
	{
		//书链接点击
		console.log("新书推荐书籍点击",e.currentTarget);

		ka(
			'info',
			'p4=2&p5=6&p6=2&p7=5&p8=' + StatMap[$(e.currentTarget).data("completed")] + '&p9=' + $(e.currentTarget).data("title") + '&p10=' + $(e.currentTarget).data("bookid")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	},
	onMoreLinkClick:function()
	{
		console.log("点击更多");
		ka(
			'info',
			'p4=2&p5=6&p6=3&p7=6'
		);
	}
});
//排行榜item视图
window.ebookweb.views.components.RankItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"ul",
	className:"top",
	template:_.template($("#rank_item_view_template").html()),
	mapping: {
		'畅销榜': '0 -64px',
		'人气榜': '0 -128px',
		'飙升榜': '0 0',
		'热搜榜': '0 -192px',
		'推荐榜': '0 -256px',
		'完结榜': '0 -320px'
	},
	stats:{//大分类埋点标识
		'畅销榜': '1',
		'人气榜': '2',
		'飙升榜': '3',
		'热搜榜': '4',
		'推荐榜': '5',
		'完结榜': '6'
	},
	events:{
		//事件
		"click li a.nav":"onRankListLinkClick",//分类排行点击
		"click li a.read":"onBookLinkClick"//书籍点击
	},
	initialize:function(){
		//初始化
		var list = this.model.get("data");
		_.each(list,function(item,index){
			item["rankCoverBackround"] = this.mapping[item["rankName"]];

			_.each(item["books"],function(sub_item,sub_index){
				sub_item["readCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(sub_item["readCount"]);
			},this);
		},this);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onRankListLinkClick:function(e){
		//分类排行点击
		console.log("分类排行点击",e.currentTarget);

		ka(
			'info',
			'p4=2&p5=13&p6='+this.stats[$(e.currentTarget).data("rankname")]
		);

		return true;
	},
	onBookLinkClick:function(e)
	{
		//书链接点击
		console.log("书籍点击",e.currentTarget);

		ka(
			'info',
			'p4=2&p5=13&p6=7&p7=' + $(e.currentTarget).data("title") + '&p8=' + $(e.currentTarget).data("rankname")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	},
});
//重磅推荐item视图
window.ebookweb.views.components.RecommendsItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"section",
	className:"item-view top",
	attributes:{
		
	},
	template:_.template($("#recommend_item_view_template").html()),
	events:{
		//事件
		"click ol li a.read":"onBookLinkClick",
		"click ol .more a":"onMoreLinkClick"
	},
	initialize:function(){
		//初始化

		//转换数据
		var list = this.model.get("data");
		_.each(list,function(item,index){
			item["readCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(item["readCount"]);
		});
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onMoreLinkClick:function(){
		//点击更多
		// var data = new PageViewModel({
		// 	title:"重磅推荐",
		// 	pageid:"recommend",
		// 	autoLoad:false,
		// 	data:this.model.get("data"),
		// 	stat_p5:7
		// });

		// console.log(data.toJSON());

		// var page = new BookListPageView({model:data});
		// mediator.trigger(POPUP_PAGE_EVENT,page);
		console.log("点击更多");
		ka(
			'info',
			'p4=2&p5=6&p6=3&p7=1'
		);

		return true;
	},
	onBookLinkClick:function(e){
		//读书点击
		console.log("读书点击监测",$(e.currentTarget));

		ka(
			'info',
			'p4=2&p5=6&p6=2&p7=1&p8=' + StatMap[$(e.currentTarget).data("completed")] + '&p9=' + $(e.currentTarget).data("title") + '&p10=' + $(e.currentTarget).data("bookid")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	}
});
//女生爱看item视图
window.ebookweb.views.components.WomenItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"section",
	className:"like-see item-view top",
	attributes:{
	},
	template:_.template($("#women_item_view_template").html()),
	events:{
		//事件
		"click ol li a":"onBookLinkClick",
		"click .more a":"onMoreLinkClick"
	},
	initialize:function(){
		//初始化

		//转换数据
		var list = this.model.get("data");
		_.each(list,function(item,index){
			item["readCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(item["readCount"]);
		});
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onBookLinkClick:function(e)
	{
		//书链接点击
		console.log("女生爱看书籍点击",e.currentTarget);

		ka(
			'info',
			'p4=2&p5=6&p6=2&p7=4&p8=' + StatMap[$(e.currentTarget).data("completed")] + '&p9=' + $(e.currentTarget).data("title") + '&p10=' + $(e.currentTarget).data("bookid")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	},
	onMoreLinkClick:function()
	{
		console.log("点击更多");
		ka(
			'info',
			'p4=2&p5=6&p6=3&p7=5'
		);
	}
});
//小编懂你item视图
window.ebookweb.views.components.XiaoBianItemView = window.ebookweb.views.ItemBaseView.extend({
	tagName:"section",
	className:"item-view top",
	attributes:{
		
	},
	template:_.template($("#xiaobian_item_view_template").html()),
	events:{
		//事件
		"click ul figure a":"onBookLinkClick",
		"click .more a":"onMoreLinkClick"
	},
	initialize:function(){
		//初始化
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		return this;
	},
	onBookLinkClick:function(e)
	{
		//书链接点击
		console.log("小编推荐书籍点击",e.currentTarget);

		var p5 = "6";
		if(this.model.get("stat_p5"))
		{
			p5 = this.model.get("stat_p5");
		}

		if(p5=="5")
		{
			//搜索结果页面
			ka(
				'info',
				'p4=2&p5='+p5+'&p6=3&p7=' + $(e.currentTarget).data("title")
			);

			console.log("搜索结果页面:",'p4=2&p5='+p5+'&p6=3&p7=' + $(e.currentTarget).data("title"));
		}
		else
		{
			ka(
				'info',
				'p4=2&p5='+p5+'&p6=2&p7=2&p8=' + StatMap[$(e.currentTarget).data("completed")] + '&p9=' + $(e.currentTarget).data("title") + '&p10=' + $(e.currentTarget).data("bookid")
			);
		}

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	},
	onMoreLinkClick:function()
	{
		console.log("点击更多");
		ka(
			'info',
			'p4=2&p5=6&p6=3&p7=3'
		);
	}
});
//书籍目录页面
window.ebookweb.views.pages.BookCatalogPageView = window.ebookweb.views.PageBaseView.extend({
	id:"book_catalog",
	className:"main-container book-detail-page",
	template:_.template($("#book_catalog_page_template").html()),
	events:{
		//事件
		"click .n-right .read a":"onOrderTypeClick",
		"click .l-title .partition":"onSelectPagerPop",
		"click .chapter .c-cont ul li a":"onSelectedPage",
		"click .l-cont ul div a":"onChapterLinkClick"
	},
	initialize:function(){
		//初始化
		this.model.set({reverse:0,page:1,pagesize:100});
		this.listenTo(this.model,"change",this.redraw);

		this.page = 1;
		this.pagesize = 100;

		this.tag = 1;
		//免费章节数默认30
		this.freeChapter = 30;

		//书籍目录页访问埋点
		ka(
			'info',
			'p4=1&p5=57'
		);
	},
	render:function(){
		//渲染
		this.redraw();

		this.getCatalog();

		return this;
	},
	destroy:function(){
		$('html').removeClass("htmlhidden")
		this.remove();
	},
	redraw:function(){
		//重新绘制
		this.$el.html(this.template(this.model.toJSON()));

		this.pager = this.$(".chapter");
		this.pager.hide();

		this.delegateEvents(this.events);
	},
	getCatalog:function(){
		//获取目录
		var _this = this;
        $('html').removeClass("htmlhidden")
		$.ajax({
			url:window.ebookweb.config.api_host+"book/chapter-list",
			method:"get",
			data:{
				bookid:this.model.get("bookid"),
				page:this.page,
				pagesize:this.pagesize,
				reverse:this.model.get("reverse")
			},
			dataType:"json",
			context:this
		}).always(function(result){
			
			//this.handleData这个方法处理后端数据，以后会删掉
			//this.handleData(result);

			console.log("书籍目录结果:",result);

			if(result.code == 200&&result.data&&result.data.length>0)
			{
				var totalpage = parseInt(result.totalsize/this.pagesize);
				var totalpage_reserve = Math.floor(result.totalsize/this.pagesize);
				if(result.totalsize%this.pagesize!=0) totalpage++;

				var data = result["data"];
				if(!_this.model.get('reverse')){
					var pagerLabel = ((this.page-1)*this.pagesize+1)+"-";
					pagerLabel+=(this.page*this.pagesize>result.totalsize ?result.totalsize:this.page*this.pagesize)+"章";
				}else{

					var pagerLabel = (result.totalsize-(this.page-1)*this.pagesize) + '-';
					pagerLabel += (this.page*this.pagesize)>result.totalsize ? "01章" : (result.totalsize-(this.page)*this.pagesize+1)+"章";

				}

				this.model.set({
					data:data,
					pagerLabel:pagerLabel,
					totalsize:result.totalsize,
					totalpage:totalpage
				});
			}
			else
			{
				// alert(result.msg || "服务器错误");
			}
		});
	},
	//处理后端数据，这个方法以后会删
	handleData:function(result){
		if(result.code == 200&&result.data&&result.data.length>0){
			//遍历对象
			result.data.forEach(function(item,index){
				if(parseInt(item["chapterSeq"]) > 29){
					item["feeStatus"] = "2"
				}
			})
		}else{
			console.log(result.msg || "服务器错误")
		}
	},
	onOrderTypeClick:function(e){
		//排序
		this.page = 1;
		this.tag = 1;

		var reverse = parseInt($(e.currentTarget).data("reverse"));
		this.model.set({reverse:reverse});
		this.getCatalog();
	},
	onSelectPagerPop:function(e){
		//选择章节pop
		var _this = this;
		var bg_list = document.querySelector(".list .close");

		this.pager.show();

		window.ebookweb.utils.Event.addEvent(bg_list,"touchmove",function (e) {
			window.ebookweb.utils.Event.preventDefault(e);
		});
		$('html').addClass("htmlhidden")
		if(this.tag){
			this.$('.close').click(function(){
				console.log('隐藏'+_this.tag)
				_this.pager.hide();
				_this.tag = 0;
				$('html').removeClass("htmlhidden")
				window.ebookweb.utils.Event.removeEvent(bg_list,"touchmove")
			})
		}else{
			console.log('显示'+this.tag)
			this.pager.show();
			this.tag = 1;
			$('html').addClass("htmlhidden")
			window.ebookweb.utils.Event.addEvent(bg_list,"touchmove",function (e) {
				window.ebookweb.utils.Event.preventDefault(e);
			})
		}
	},
	onSelectedPage:function(e){
		//选择了页码
		console.log("选择页码");
		this.pager.hide();

		var page = $(e.currentTarget).data("page");
		this.page = page;
		this.getCatalog();
	},
	onChapterLinkClick:function(e){
		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url,"webview");
	}
});
//书籍详情页面
window.ebookweb.views.pages.BookDetailPageView = window.ebookweb.views.PageBaseView.extend({
	id:"book_detail",
	className:"main-container book-detail-page",
	template:_.template($("#book_detail_page_template").html()),
	events:{
		//事件
		"click .nav-bar .left a":"clickHistoryJudge",
		"click #reader_books_section .common-go a":"changeReadersBooks",
		"click .book-detail-console-footer .layer .l-read":"sendToDesk",
		"click .i-btns .i-send":"sendToDesk",
		"click .book-detail-console-footer .layer .l-send a":"startRead",
		"click .i-btns .i-read a":"startRead",
		"click .info .i-cont .i-syno":"switchDescription",
		"click .info .i-cont .i-syno.open .arrow":"switchDescription",
		"click .info .i-cont .i-syno.close .arrow":"switchDescription",
		"click .info .i-list p a":"onChapterLinkClick"
	},
	initialize:function(){
		//初始化
		this.listenTo(this.model,"change",this.checkDataAreloaded);
		this.tagicon = false;
		this.version = JSON.parse(window.splash.jsGetDeviceInfo())['app_version'];

		//判断是不是9.9以上或以下版本，赋值一个全局变量，下面好几处都要用到
		this.versionJudge = this.checkoutVersion(this.version);  //布尔值 true9.9+ false9.9-
		//书籍详情页访问埋点
		ka(
			'info',
			'p4=1&p5=56'
		);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		this.handlestartRead(this.version);

		console.log("渲染书籍详情:",this.model.toJSON());

		//底部操作栏
		this.consoleFooter = this.$(".book-detail-console-footer");
		this.consoleFooter.hide();

		var self = this;
		setTimeout(function(){
			$(window).on("scroll",self.onWindowScroll.bind(self));
		},500);

		this.getBookDetail();//获取书籍详情
		// this.getBookCatalog();//获取目录
		// this.getAuthorBooks();//获取作者写的过的书籍

		//控制显示隐藏
		if(this.$(".info .i-cont .i-syno").length>0)
		{
			var line_h = parseInt(this.$(".info .i-cont .i-syno").css("line-height"));
			var h = this.$(".info .i-cont .i-syno").height();
			if(h>line_h*3)
			{
				this.$(".info .i-cont .i-syno").addClass("open");	
			}else{
				//小于两行执行，让这个icon永远不显示，在switchDescription里面
				this.tagicon = true;
			}

			this.delegateEvents(this.events);
		}

		// console.log("描述dom高度:",parseInt(this.$(".info .i-cont .i-syno").css("line-height")),this.$(".info .i-cont .i-syno").height());

		return this;
	},
	//处理发送至桌面样式，9.9和9.9以下样式分开处理
	handlestartRead:function(){
		
		if(this.versionJudge){
			//9.9以上版本
			this.$("div.i-send").show();
			
		}else{
			//9.9以下
			console.log("9.9以下")
			this.$("div.i-send").hide();
			this.$("div.i-read").css({
				"marginLeft":0,
				"width":"100%"
			});
			this.$("div.i-read a").css({
				"width":"100%"
			});

			this.$(".footer").css({
				"height":"1.37rem"
			})
		}
	},
	//处理添加到桌面的返回
	clickHistoryJudge:function(e){

		if(window.history.length <= 1){
			window.ebookweb.utils.Event.preventDefault(e);
			
			if(window.splash) 
			{
				window.splash.onBackPressed(true);//退出当前webview
			};
		}
	},
	destroy:function(){
		console.log("移除详情页面");
		$(window).off("scroll");
		this.remove();
	},
	checkDataAreloaded:function(){
		console.log(":::::::"+this.model.get("catalog"))
			//console.log(this.model.get("data")+"::::"+this.model.get("authorBooks")+":::"+this.model.get("catalog")+":::"+this.model.get("readerBooks"))
			if(this.model.get("data") && this.model.get("authorBooks") && this.model.get("catalog") && this.model.get("readerBooks"))
			{
					this.render();
			}
	},
	switchDescription:function(){
		//展开或者关闭描述
		//小于两行执行
		if(this.tagicon){return false;}

		if(!this.isDescOpen)
		{
			this.isDescOpen = true;
			this.$(".info .i-cont .i-syno").removeClass("open");
			this.$(".info .i-cont .i-syno").addClass("close");
			console.log('close')
			this.delegateEvents(this.events);
		}
		else
		{
			this.isDescOpen = false;
			this.$(".info .i-cont .i-syno").removeClass("close");
			this.$(".info .i-cont .i-syno").addClass("open");
			console.log('open')
			this.delegateEvents(this.events);
		}
	},
	onWindowScroll:function(e){
		// console.log("book detail scroll:",$(window).scrollTop(),this.$(".i-btns").position().top,this.$(".i-btns").height());
		if($(window).scrollTop()>this.$(".i-btns").position().top+this.$(".i-btns").height())
		{
			if(this.versionJudge){
				this.consoleFooter.show();
			}else{
				this.consoleFooter.hide();
			}
		}
		else
		{
			this.consoleFooter.hide();
		}
	},
	getBookDetail:function()
	{
		//获取书籍详情
		if(!this.model.get("data"))
		{
			//获取书籍详情
			$.ajax({
				url:window.ebookweb.config.api_host+"book/detail",
				method:"get",
				data:{
					bookid:this.model.get("bookid")
				},
				dataType:"json",
				context:this
			}).always(function(result){
				console.log("书籍详情结果:",result);

				if(result.code == 200&&result.data&&result.data.length>0)
				{
					var data = result["data"][0];
					data["wordCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(data["wordCount"]);
					this.model.set({data:data,title:data["title"]});

					this.getBookCatalog();//获取目录
					this.getAuthorBooks();//获取作者写的过的书籍

					this.getReaderBooks();//获取书友读过的书籍
				}
				else
				{
					this.model.set({data:[]});
					alert(result.msg || "服务器错误");
				}
			});
		}
	},
	getBookCatalog:function(){
		//获取书籍目录
		if(!this.model.get("catalog"))
		{
			$.ajax({
				url:window.ebookweb.config.api_host+"book/chapter-list",
				method:"get",
				data:{
					bookid:this.model.get("bookid"),
					page:1,
					pagesize:2,
					reverse:0
				},
				dataType:"json",
				context:this
			}).always(function(result){
				console.log("书籍目录结果:",result);

				if(result.code == 200&&result.data&&result.data.length>0)
				{
					var data = result["data"];
					var catalog = {
						totalsize:result["totalsize"],
						list:data
					};

					//设置开始阅读url,直接从第一章的数据里获取
					console.log("书籍目录结果:",data);
					this.model.get("data")["url"] = data[0]["url"];

					this.getBookLastCatalog(catalog);
				}
				else
				{
					// alert(result.msg || "服务器错误");
				}
			});
		}
	},
	getBookLastCatalog:function(catalog){
		//获取书籍最后章节
		if(!this.model.get("catalog"))
		{
			$.ajax({
				url:window.ebookweb.config.api_host+"book/chapter-list",
				method:"get",
				data:{
					bookid:this.model.get("bookid"),
					page:1,
					pagesize:1,
					reverse:1
				},
				dataType:"json",
				context:this
			}).always(function(result){
				console.log("书籍最后目录结果:",result);

				if(result.code == 200&&result.data&&result.data.length>0)
				{
					var data = result["data"][0];
					var date = new Date();
					// data["updateTime"] = "20160128213439";
					if(data["updateTime"]&&data["updateTime"].length>=14)
					{
						//转换时间
						date.setFullYear(parseInt(data["updateTime"].substr(0,4)));
						date.setMonth(parseInt(data["updateTime"].substr(4,2))-1);
						date.setDate(parseInt(data["updateTime"].substr(6,2)));
						date.setHours(parseInt(data["updateTime"].substr(8,2)));
						date.setMinutes(parseInt(data["updateTime"].substr(10,2)));
						date.setSeconds(parseInt(data["updateTime"].substr(12,2)));
					}
					var times = (new Date().getTime()-date.getTime())/1000/60/60/24;
					console.log(times)
					if(times < 31){
						data["updateTimeAgo"] = window.ebookweb.utils.Calculator.getDateDiff(date.getTime());
						catalog["lastChapter"] = data;
						
					}
					this.model.set({catalog:catalog});
					this.checkDataAreloaded();
				}
				else
				{
					this.model.set({catalog:[]});
					alert(result.msg || "服务器错误");
				}
			});
		}
	},
	getAuthorBooks:function()
	{
		console.log("getAuthorBooks:",this.model.get("data")["authorId"]);
		//获取作者写过的书籍
		if(!this.model.get("authorBooks"))
		{
			$.ajax({
				url:window.ebookweb.config.api_host+"book/books-by-author",
				method:"get",
				data:{
					authorid:this.model.get("data")["authorId"] || "10669744",
					except:this.model.get("data")["bookid"],
					page:1,
					pagesize:3
				},
				dataType:"json",
				context:this
			}).always(function(result){
				console.log("作者写过的书籍结果:",result);

				if(result.code == 200&&result.data&&result.data.length>0)
				{
					var data = result["data"];
					this.model.set({authorBooks:data,authorBooksTotalSize:result["totalsize"]});
				}
				else
				{
					// alert(result.msg || "服务器错误");
					this.model.set({authorBooks:[],authorBooksTotalSize:0});
				}
			});
		}
	},
	getReaderBooks:function()
	{
		//获取书友还读过的书籍
		$.ajax({
			url:window.ebookweb.config.api_host+"book/similar-books",
			method:"get",
			data:{
				cateid:this.model.get("data")["cateId"],
				page:1,
				pagesize:3
			},
			dataType:"json",
			context:this
		}).always(function(result){
			console.log("书友还读过的书籍:",result);

			if(result.code == 200&&result.data&&result.data.length>0)
			{
				var data = result["data"];
				if(!this.model.get("readerBooks"))
				{
					this.model.set({readerBooks:data});
				}
				else
				{
					//换一换
					this.$("#reader_books_section .r-list ul").html("");//清空
					_.each(data,function(item,index){
						var itemView = _.template($("#book_detail_page_book_figure_item_template").html())(item);
						
						this.$("#reader_books_section .r-list ul").append(itemView);
					},this);
				}
			}
			else
			{
				this.model.set({readerBooks:[]});
				// alert(result.msg || "服务器错误");
			}
		});
	},
	changeReadersBooks:function(){
		//换一换
		console.log("换一换");
		this.getReaderBooks();
	},
	sendToDesk:function(){
		//发送到桌面
		console.log("发送到桌面:",this.model.get("data"));
		console.log(window.splash + "这个有没有")
		if(window.splash)
		{
			var data = this.model.get("data");
			var json = window.read.jsGetDeviceInfo();
			var json_version = JSON.parse(json)['app_version'];

			if(this.versionJudge){
				
				//9.9以上版本
				window.splash.installShortCut(data["title"],encodeURI(data["imgUrl"]),window.location.href,"readwebview");
				window.read.JSShowToast("添加成功")
			}else{
				// 9.9以下 不做处理
				// window.splash.installShortCut(data["title"],encodeURI(data["imgUrl"]),window.location.href,"webview");
			  // window.read.JSShowToast("添加成功")
			}
			
		}
	},

	checkoutVersion:function(str,fixstr){
		if(!str) {
			alert('请输入参数');
			return;
		}
		if(!fixstr) fixstr = "9.9.0";

		var strA = str.split("."),
				fixstrA = fixstr.split(".");

		if(strA[0] < fixstrA[0]){
			return false;
		}

		if(strA[1] < fixstrA[1]){
			return false;
		}

		if((strA[2] ? strA[2] : 0) >= (fixstrA[2] ? fixstrA[2] : 0)){
			return true;
		}else{
			return false;
		}
	},

	startRead:function(e){
		//开始阅读
		var p6 = $(e.currentTarget).data("p6");

		console.log("开始阅读点击监测",p6,$(e.currentTarget));

		ka(
			'info',
			'p4=2&p5=45&p6='+p6
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url,"webview");
	},
	onChapterLinkClick:function(e){
		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url,"webview");
	}
});
//一般书籍列表页面视图
window.ebookweb.views.pages.BookListPageView = window.ebookweb.views.PageBaseView.extend({
	id:"booklist",
	className:"main-container book-list-page",
	template:_.template($("#book_list_page_template").html()),
	events:{
		//事件
		"click .nav-bar .left a":"onBackClick",
		"click .nav-bar .search":"onSearchLinkClick",//搜索
		"click .nav-bar .last-read":"onLastReadLinkClick"//最近阅读
	},
	visitStats:{
		"重磅推荐":"p5=2",
		"小编懂你":"p5=3",
		"男生爱看":"p5=4",
		"女生爱看":"p5=5",
		"新书首发":"p5=6",
		"言情":"p5=32",
		"都市":"p5=33",
		"玄幻":"p5=34",
		"仙侠":"p5=35",
		"穿越":"p5=36",
		"官场":"p5=37",
		"奇幻":"p5=38",
		"灵异":"p5=39",
		"武侠":"p5=40",
		"科幻":"p5=41",
		"历史":"p5=42",
		"游戏":"p5=43",
		"笑话":"p5=44",
		"校园":"p5=45",
		"军事":"p5=46",
		"生活休闲":"p5=47",
		"影视剧本":"p5=48",
		"文学小说":"p5=49",
		"文史传记":"p5=50",
		"经管励志":"p5=51",
		"社科科普":"p5=52",
		"教育教辅":"p5=53",
		"情感小说":"p5=54",
		"灵异悬疑":"p5=55"
	},
	initialize:function(){
		//初始化
		this.bookListView = new window.ebookweb.views.components.BookListView({
			model:new window.ebookweb.models.ItemViewModel({
				autoLoad:this.model.get("autoLoad")||false,
				autoLoadURL:this.model.get("autoLoadURL")||null,
				data:this.model.get("data"),
				title:this.model.get("title"),
				stat_p5:this.model.get("stat_p5") || 0,
			})
		});

		console.log("book list page stat_p5:",this.model.get("title"),this.bookListView.model.get("stat_p5"));

		//列表页面访问埋点
		var title = this.model.get("title");
		console.log("书籍列表访问埋点:",title,this.visitStats[title],this.model.toJSON());
		if(this.visitStats[title])
		{
			//有标题可以识别的
			ka(
				'info',
				'p4=1&'+this.visitStats[title]+(this.model.get("stat_p6") ?"&p6="+this.model.get("stat_p6"):"")
			);
		}
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));
		this.$("section").append(this.bookListView.render().el);
		this.bookListView.addBooks(this.model.get("data"));

		this.$("section").scrollTop(0);
		$(window).scrollTop(0);

		return this;
	},
	onSearchLinkClick:function(){
		//搜索点击
		console.log("点击搜索");
		ka(
			'info',
			'p4=2&p5=1&p6=2'
		);
	},
	onLastReadLinkClick:function(){
		//最近阅读点击
		console.log("点击最近阅读");
		ka(
			'info',
			'p4=2&p5=1&p6=1'
		);
	},
	onBackClick:function(){
		//点击返回
		console.log("返回");
		// window.history.back();
	}
});
//最近阅读页面视图
window.ebookweb.views.pages.LastReadPageView = window.ebookweb.views.PageBaseView.extend({
	id:"last_read",
	className:"main-container last-read-page",
	template:_.template($("#last_read_page_template").html()),
	events:{
		//事件
		"click .nav-bar .left a":"onBackClick",
		"click .nav-bar .search":"onSearchLinkClick",//搜索
		"click .nav-bar .book-shop":"onBookShopLinkClick",//书城
		"click .fig a":"onBookLinkClick",
		"click .empty .nav":"onEmptyBookShopLinkClick"
	},
	initialize:function(){
		//初始化
		this.loaded = false;
		this.model.set({dataisloaded:false});
		this.listenTo(this.model,"change:data",this.render);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		if(!this.loaded)
		{
			this.loaded = true;

			$.ajax({
				url:window.ebookweb.config.api_host+"book/recent-read",
				method:"get",
				data:{

				},
				dataType:"json",
				context:this
			}).always(function(result){
				//最近阅读结果返回
				console.log("最近阅读结果:",result);

				this.model.set({dataisloaded:true,data:result.bookmarkList ||[]});

				//访问埋点
				if(this.model.get("data").length>0)
				{
					//有
					ka(
						'info',
						'p4=1&p5=11&p6=1'
					);
				}
				else
				{
					//无
					ka(
						'info',
						'p4=1&p5=11&p6=2'
					);
				}
			});
		}

		return this;
	},
	onSearchLinkClick:function(){
		//搜索点击
		console.log("点击搜索");
		ka(
			'info',
			'p4=2&p5=1&p6=2'
		);
	},
	onBookShopLinkClick:function(){
		//书城点击
		console.log("点击书城");
		ka(
			'info',
			'p4=2&p5=1&p6=3'
		);
	},
	onEmptyBookShopLinkClick:function(){
		//空白无最近阅读页面点击去书城
		console.log("点击空白页去书城");
		ka(
			'info',
			'p4=2&p5=3&p6=1'
		);
	},
	onBackClick:function(){
		//点击返回
		console.log("返回");
		window.history.back();
	},
	onBookLinkClick:function(e){
		//点击读书链接
		console.log("点击读书链接",e.currentTarget);
		ka(
			'info',
			'p4=2&p5=2&p6=1&p7='+$(e.currentTarget).data("title")
		);

		var url = $(e.currentTarget).attr("href");
		return window.ebookweb.utils.openBookWeb(url);
	}
});
//正在加载中视图
window.ebookweb.views.pages.LoadingPageView = window.ebookweb.views.PageBaseView.extend({
	className:"loading-page",
	template:_.template($("#loading_view_template").html()),
	events:{

	},
	initialize:function(){
		//初始化
	},
	render:function(){
		//渲染
		this.$el.html(this.template());
		this.$el.css("height",$(document).height());

		console.log("h:",$(window).height(),$(document).height());

		return this;
	}
});
//首页视图
window.ebookweb.views.pages.MainPageView = window.ebookweb.views.PageBaseView.extend({
	id:"main",
	className:"main-container for-sub-tab",
	template:_.template($("#main_page_template").html()),
	events:{
		//事件
		"click .nav-bar .left .back":"onBackClick",
		"click .nav-tabbar ul li":"onNavClick",//导航点击
		"click .nav-bar .search":"onSearchLinkClick",//搜索
		"click .nav-bar .last-read":"onLastReadLinkClick"//最近阅读
	},
	initialize:function(){
		//初始化
		window.ebookweb.mediator.on(window.ebookweb.events.CHANGE_MAIN_PAGE_TAB_EVENT,this.changeTabPageById,this);

		this.currentTabPage = "favorite";//当前是精选页面
		this.views = [];
	},
	render:function(callback){
		//渲染
		this.$el.html(this.template());
		this.container = this.$("#favorite");
		this.rankContainer = this.$("#ranking");
		this.classesContainer = this.$("#class");
		this.freeContainer = this.$("#free");

		//最近阅读
		this.lastestReadItemView = this.drawView("lastread",{title:"获取中..."});

		if(!this.model.get("data"))
		{
			//获取数据
			$.ajax({
				url:window.ebookweb.config.api_host+"index",
				method:"get",
				data:null,
				dataType:"json",
				context:this
			}).always(function(result){
				//结果,目前返回是一个数据对象,之后加上错误码判断
				if(!_.isEmpty(result) && result["emphasis"])
				{
					this.model.set("data",result);
					this.renderItems();
					this.renderLastestReadItem();

					//精选页面
					ka(
						'info',
						'p4=1&p5=1'
					);

					this.delegateEvents(this.events);//事件需要重新绑定
				}
				else
				{
					//显示错误页面
					console.log("获取数据错误",callback);
				}

				if(callback) callback(result);
			});
		}
		else
		{
			//已经获取过,直接渲染
			var tabId = this.currentTabPage//当前是精选页面
			this.currentTabPage = null;

			this.$("section").hide();
			
			this.changeTabPageById(tabId);
			this.renderItems();
			this.renderLastestReadItem();

			this.delegateEvents(this.events);//事件需要重新绑定

			if(callback) callback();
		}

		return this;
	},
	show:function(){
		//显示
		_.each(this.views,function(item,index){
			//重新绑定所有组件事件
			if(item.events) item.delegateEvents(item.events);
		},this);
	},
	renderLastestReadItem:function(){
		//渲染最近阅读
		var result = this.model.get("lastestRead");
		if(!_.isEmpty(result) && result["bookmarkList"] && result["bookmarkList"].length>0)
		{
			this.lastestReadItemView.model.set({data:this.model.get("lastestRead")["bookmarkList"][0]});
			this.lastestReadItemView.$el.css("display","block");
		}
		else
		{
			//获取最近阅读
			$.ajax({
				url:window.ebookweb.config.api_host+"book/recent-read",
				method:"get",
				data:null,
				dataType:"json",
				context:this
			}).always(function(result){
				//结果,目前返回是一个数据对象,之后加上错误码判断
				console.log("最近阅读:",result);
				// if(result.length<=0) result = lastestRead;

				// result = {
				// 	"bookmarkList":[{
				// 		title:"标题",
				// 		url:"http://www.baidu.com"
				// 	}]
				// };

				if(!_.isEmpty(result) && result["bookmarkList"] && result["bookmarkList"].length>0)
				{
					console.log("result:",result);
					
					this.lastestReadItemView.model.set({data:result["bookmarkList"][0]});
					this.lastestReadItemView.$el.css("display","block");
				}
				else
				{
					console.log("没有最近阅读");
				}

				this.model.set("lastestRead",result);
			});
		}
	},
	renderItems:function(){
		var result = this.model.get("data");

		console.log(result);
		if(!_.isEmpty(result) && result["emphasis"])
		{

			window.ebookweb.data.GlobalData["main"] = result;

			this.drawView("emphasis",result["emphasis"]);//重磅推荐
			this.drawView("navs",result["navs"]);//大分类
			this.drawView("xiaobian",result["xiaobian"]);//小编懂你
			this.drawView("man",result["men"]);//男生爱看
			this.drawView("women",result["women"]);//女生爱看
			this.drawView("hotBook",result["hotBook"]);//热搜榜
			this.drawView("newBook",result["newBook"]);//新书首发
			this.drawView("entrances",result["recommend"]);//分类导航
			this.drawView("footer",null);//底部

			//排行榜
			this.drawView("rank",result["rank"]);

			//分类
			this.drawView("classes",result["classes"]);

			//免费
			this.drawView("free",null);//底部
		}
		else
		{
			// alert(result.msg || "服务器数据错误");
		}
	},
	drawView:function(type,data){
		//根据类型绘制视图
		var itemView,model;
		switch(type)
		{
			case "lastread"://最近阅读
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.LastReadItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "emphasis"://重磅推荐
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.RecommendsItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "navs"://大分类
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.NavsItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "xiaobian"://小编懂你
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.XiaoBianItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "man"://男生爱看
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.ManItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "women"://女生爱看
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.WomenItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "hotBook"://热搜榜
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.HotBookItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "newBook"://新书首发
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.NewBookItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "entrances"://分类导航
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.EntrancesItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "footer"://底部
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.FooterItemView({model:model});
				this.container.append(itemView.render().el);
			break;
			case "rank"://排行榜
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.RankItemView({model:model});
				this.rankContainer.append(itemView.render().el);
			break;
			case "classes"://分类标签页面
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.ClassesItemView({model:model});
				this.classesContainer.append(itemView.render().el);
			break;
			case "free"://免费标签页面
				model = new window.ebookweb.models.ItemViewModel({type:type,data:data});
				itemView = new window.ebookweb.views.components.FreeItemView({model:model});
				this.freeContainer.append(itemView.render().el);
			break;
		}

		this.views.push(itemView);

		return itemView;
	},
	onBackClick:function(e){
		console.log("点击首页返回,退出webview");
		if(window.splash && window.splash.onBackPressed) 
		{
			window.splash.onBackPressed(true);//退出当前webview

			return false;
		}
		else
		{
			window.history.back();
			return true;
		}
	},
	onNavClick:function(e){
		//tab导航点击
		var target = $(e.currentTarget).data("target");
		console.log("target:",target);

		this.changeTabPageById(target);
	},
	onSearchLinkClick:function(){
		//搜索点击
		console.log("点击搜索");
		ka(
			'info',
			'p4=2&p5=1&p6=2'
		);

		return true;
	},
	onLastReadLinkClick:function(){
		//最近阅读点击
		console.log("点击最近阅读");
		ka(
			'info',
			'p4=2&p5=1&p6=1'
		);

		return true;
	},
	changeTabPageById:function(id)
	{
		//根据
		if(this.currentTabPage != id)
		{
			//不是当前页面,可以切换
			this.$("#"+this.currentTabPage).hide();

			this.currentTabPage = id;

			this.$("#"+this.currentTabPage).show();

			//改变导航状态
			this.$(".nav-tabbar.top li").removeClass();
			this.$("#"+this.currentTabPage+"_tab_link").addClass("active");

			//访问埋点
			var tab_stats = {"favorite":1,"ranking":12,"class":31,"free":59};
			ka(
				'info',
				'p4=1&p5='+tab_stats[id]
			);
		}

		$(window).scrollTop(0);
	}
});
//排行榜书籍列表页面视图
window.ebookweb.views.pages.RankListPageView = window.ebookweb.views.PageBaseView.extend({
	id:"main",
	className:"main-container for-sub-tab rank-list-page",
	template:_.template($("#rank_list_page_template").html()),
	stats:{//大分类埋点标识
		'畅销榜': '14',
		'人气榜': '15',
		'飙升榜': '16',
		'热搜榜': '17',
		'推荐榜': '18',
		'完结榜': '19'
	},
	events:{
		//事件
		"click .nav-bar .left a":"onBackClick",
		"click nav ul li":"onTabButtonClick",
		"click .nav-bar .search":"onSearchLinkClick",//搜索
		"click .nav-bar .last-read":"onLastReadLinkClick"//最近阅读
	},
	initialize:function(){
		//初始化
		this.tabs = ["week","month","all"];
		this.tabsScrollPosition = {
			week:0,
			month:0,
			all:0
		};
		this.curtab = this.tabs[0];
		this.bookListViewModels = {};
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		for(var i = 0;i<this.tabs.length;i++)
		{
			var data = {
				navtitle:this.model.get("title"),
				curpage:1,
				stat_p5:this.stats[this.model.get("title")],//统计来源
				stat_p7:i+1,
				books:new window.ebookweb.models.BookList(),
				autoLoad:true,
				autoLoadURL:this.model.get("autoLoadURL")||null
			};
			data["autoLoadURL"]+="&type="+this.tabs[i];//加载数据接口拼接

			this.bookListViewModels[this.tabs[i]] = new window.ebookweb.models.ItemViewModel(data);
		}

		this.showBookListViewByIndex(0);
		$(window).scrollTop(0);

		return this;
	},
	onBackClick:function(){
		//点击返回
		console.log("返回");
		window.history.back();
	},
	onSearchLinkClick:function(){
		//搜索点击
		console.log("点击搜索");
		ka(
			'info',
			'p4=2&p5=1&p6=2'
		);
	},
	onLastReadLinkClick:function(){
		//最近阅读点击
		console.log("点击最近阅读");
		ka(
			'info',
			'p4=2&p5=1&p6=1'
		);
	},
	onTabButtonClick:function(e){
		//标签点击
		var index = $(e.currentTarget).index();
		this.showBookListViewByIndex(index);

		ka(
			'info',
			'p4=2&p5='+this.stats[this.model.get("title")]+'&p6='+(index+2)
		);
	},
	showBookListViewByIndex:function(index){
		//根据位置显示书籍列表
		console.log("showBookListViewByIndex:",index);

		//访问埋点
		var tab_stats = {
			"畅销榜":[13,14,15],
			"人气榜":[16,17,18],
			"飙升榜":[19,20,21],
			"热搜榜":[22,23,24],
			"推荐榜":[25,26,27],
			"完结榜":[28,29,30]
		};
		ka(
			'info',
			'p4=1&p5='+tab_stats[this.model.get("title")][index]
		);
		//访问埋点结束

		this.tabsScrollPosition[this.curtab] = $(window).scrollTop();//记录滚动位置

		if(this.bookListView)
		{
			//有旧的
			this.bookListView.destroy();
			this.bookListView.remove();
		}

		this.$("nav ul li").removeClass();
		this.$("nav ul li:eq("+index+")").addClass("active");

		this.curtab = this.tabs[index];

		var data = this.bookListViewModels[this.curtab];//存储的数据对象
		var books = data.get("books").toJSON();

		this.bookListView = new window.ebookweb.views.components.BookListView({
			model:data
		});

		console.log("books:",books);

		// if(books.length>0) this.bookListView.addBooks(books);//把之前加载的数据加上去

		this.$("section ul .rank-"+this.tabs[index]).append(this.bookListView.render().el);

		//隐藏和显示
		this.$("ul div").hide();
		this.$("ul .rank-"+this.curtab).show();

		//滚动到历史位置
		$(window).scrollTop(this.tabsScrollPosition[this.curtab]);
	}
});
//搜索页面
window.ebookweb.views.pages.SearchPage = window.ebookweb.views.PageBaseView.extend({
	tagName:"div",
	id:"search",
	className:"main-container search-page",
	template:_.template($("#search_page_template").html()),
	events:{
		//事件
		"click header .nav.back":"onBackClick",
		"click form button":"onClearButtonClick",
		"keydown form input":"onKeyDown",
		"focusin form input":"onFocusIn",
		"focusout form input":"onFocusOut",
		"keydown form input":"onKeyDown",
		"click .page-control .prev":"prevPage",
		"click .page-control .next":"nextPage",
		"click .search-history h3 button":"clearHistory",
		"click .search-history ul li a":"onSearchHistoryItemClick",
		"click .hot-book ul li a":"onHotBooksItemClick",
		"click .hot-book h3 button":"onGetHotKeywordsClick"
	},
	initialize:function(){
		//初始化
		this.curpage = 1;
		this.keyword = "";
		this.lastpagesize = 0;
		this.gotSearchResult = false;//是否获取到搜索结果

		var data = this.model.get("data");
		var history = data["history"];
		history.fetch();//本地获取搜索记录

		//转换
		data["historyList"] = history.toJSON().reverse();//反转,最新的在前面

		//访问埋点
		ka(
			'info',
			'p4=1&p5=9'
		);
	},
	render:function(){
		//渲染
		this.$el.html(this.template(this.model.toJSON()));

		this.historyItem = this.$(".search-history");

		//搜索记录
		var history = this.model.get("data")["history"];
		if(history.length<=0)
		{
			// this.$(".search-history").hide();
		}

		var keyword = $.trim(this.model.get("data")["keyword"]);
		if(keyword){
			this.$("form input").val(keyword);
			this.curpage = 1;
			this.keyword = keyword;
			this.loadBooks();
			this.addHistory(keyword);//增加历史记录
		}else{
			//自动获取焦点尝试
			var self = this;
			this.$("form input").focus();
			setTimeout(function(){
				self.$("form input").focus();
			},500);
		}
		return this;
	},
	addHistory:function(keyword){
		if($.trim(keyword).length == 0){
			return;
		}
		//添加一个历史记录
		var data = this.model.get("data");
		var history = data["history"];
		history.fetch();//本地获取搜索记录

		// this.$(".search-history").show();

		console.log("add:",keyword);

		//销毁同名的
		var sames = history.where({keyword:keyword});
		for(var i = 0;i<sames.length;i++)
		{
			sames[i].destroy();
		}

		//添加到列表
		var item = _.template($("#search_page_history_item_template").html())({keyword:keyword});

		this.$(".search-history a[data-keyword='" + keyword + "']").parent().remove();
		this.$(".search-history ul").prepend(item);

		//创建
		history.create({
			keyword:keyword
		});
	},
	clearHistory:function(){
		//清空历史搜索记录
		var history = this.model.get("data")["history"];
		history.fetch();

		console.log("清空历史搜索记录:",history.toJSON());

		_.each(history.models.concat(),function(item,index){
			try
			{
				console.log(index);
				item.destroy();
			}
			catch(e)
			{
				console.log("清空出错:",e);
			}
		});

		history.reset();

		console.log("清空");

		//
		this.$(".search-history ul").html("");

		ka('info', 'p4=2&p5=4&p6=5');//统计
	},
	onSearchHistoryItemClick:function(e){
		//点击历史搜索关键字
		var keyword = $(e.currentTarget).data("keyword");
		this.$("form input").val(keyword);

		console.log("点击历史搜索:",keyword,e.currentTarget);

		this.curpage = 1;
		this.keyword = keyword;

		ka('info', 'p4=2&p5=4&p6=4&p7=' + this.keyword);//统计

		this.loadBooks();

		return true;
	},
	onGetHotKeywordsClick:function(){
		console.log("换一批热搜词");

		ka('info', 'p4=2&p5=4&p6=6');//统计

		$.ajax({
			url:window.ebookweb.config.api_host+"hotBook",
			method:"get",
			data:null,
			dataType:"json",
			context:this
		}).always(function(result){
			//结果,目前返回是一个数据对象,之后加上错误码判断
			console.log(result);
			if(!_.isEmpty(result))
			{
				var html = _.template($("#search_page_hot_book_item_template").html())({infos:result});
				this.$(".hot-book ul").html(html);
			}
			else
			{
				alert("没有数据");
			}
		});
	},
	onHotBooksItemClick:function(e){
		//大家都在搜索书籍点击
		var keyword = $.trim($(e.currentTarget).data("keyword"));
		if(this.$(".result").is(":hidden"))
		{
			//未搜索
			ka(
				'info',
				'p4=2&p5=4&p6=3&p7=' + keyword
			);

			console.log("大家都在搜:","p4=2&p5=4&p6=3&p7=");
		}
		else
		{
			//搜索结果页面
			ka(
				'info',
				'p4=2&p5=5&p6=2&p7=' + keyword
			);

			console.log("搜索结果页面,大家都在搜:","p4=2&p5=4&p6=3&p7=");
		}

		this.$("form input").val(keyword);
		this.curpage = 1;
		this.keyword = keyword;
		this.loadBooks();
		this.addHistory(keyword);//增加历史记录
		return true;
	},
	onBackClick:function(){
		//点击返回
		console.log("取消搜索");
		ka('info', 'p4=2&p5=4&p6=2');//统计
		window.history.back();
	},
	onClearButtonClick:function(){
		//清除按钮
		this.$("form input").val("");
	},
	onKeyDown:function(e){
		//回车
		if(e.keyCode == 13)
		{
			this.$("form input").blur();

			var keyword = $.trim(this.$("form input").val());
			this.$("form input").val(keyword);//去掉两端空格
			//如果没有输入搜索关键字，则使用 placeholder 作为关键字
			if(keyword.length == 0){
				keyword = $.trim(this.$("form input").attr("placeholder"));
			}
			if(keyword.length>0)
			{
				this.curpage = 1;
				this.keyword = keyword;

				ka('info', 'p4=2&p5=4&p6=1&p7=' + keyword);//搜索统计

				this.loadBooks();//加载
				this.addHistory(keyword);//增加历史记录
			}
			else
			{
				console.log("关键字不能为空");
			}

			this.$("form input").blur();
		}
	},
	prevPage:function(){
		//上一页
		if(this.isLoading) return;
		
		console.log("上一页");
		this.curpage--;
		if(this.curpage<1) this.curpage=1;

		this.loadBooks();
	},
	nextPage:function(){
		//下一页
		if(this.isLoading) return;

		console.log("下一页");
		this.curpage++;

		this.loadBooks();
	},
	onFocusIn:function(){
		this.$(".result").hide();
		if(this.xiaobian) this.xiaobian.$el.hide();
		if(this.historyItem) this.historyItem.show();

		//重新绑定事件
		this.delegateEvents(this.events);

		console.log("输入框获取到了焦点,重新返回搜索状态");

		ka('info', 'p4=2&p5=1&p6=2');//统计
	},
	onFocusOut:function(e){
		// if(this.gotSearchResult) this.$(".result").show();

		return true;
	},
	loadBooks:function(){
		if(this.isLoading) {
			return;
		}

		if(this.keyword == "免费"){
			window.location.hash = "#main/free";
			return;
		}

		this.isLoading = true;
		$.ajax({
			url:window.ebookweb.config.api_host+"search",
			method:"get",
			data:{
				page:this.curpage,
				keyword:this.keyword
			},
			dataType:"json",
			context:this
		}).always(function(result){
			console.log("search:",result);
			this.gotSearchResult = true;//是否获取到搜索结果

			this.isLoading = false;

			this.$(".list ul").html("");//清空

			if(result.data)
			{
				this.$(".result").show();

				if(result.count>0)
				{
					//有结果
					this.$(".not-found").hide();
					this.$(".list").show();
					this.$(".page-control").show();
					this.$(".page-control .prev").attr("disabled",this.curpage<=1);
					this.$(".page-control .next").attr("disabled",(result.data.length<this.lastpagesize || result.data.length>=result.count));

					this.$(".list .book-count").html(result.count);

					this.lastpagesize = result.data.length;

					//加上
					this.$(".list ul").html("");//清空
					_.each(result.data,function(item,index){
						//转换下数字
						item["readCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(item["readCount"]);
						item["wordCountFormated"] = window.ebookweb.utils.Calculator.fixedCount(item["wordCount"]);

						var data = new window.ebookweb.models.BookItem({stat_p5:"5",data:item});
						var itemView = new window.ebookweb.views.components.BookListItemView({
							model:data
						});

						this.$(".list ul").append(itemView.render().el);
					},this);

					//隐藏历史记录
					this.historyItem.hide();

					//加上小编懂你
					if(!this.xiaobian)
					{
						var data = new window.ebookweb.models.ItemViewModel({stat_p5:"5",data:window.ebookweb.data.GlobalData["main"]["xiaobian"]});
						this.xiaobian = new window.ebookweb.views.components.XiaoBianItemView({model:data});

						this.$el.append(this.xiaobian.render().el);
					}

					// this.xiaobian.show();

					ka('info', 'p4=1&p5=10&p6=1&p7=' + this.keyword);//统计-有结果
				}
				else
				{
					this.$(".not-found").show();
					this.$(".list").hide();
					this.$(".page-control").hide();

					ka('info', 'p4=1&p5=10&p6=2&p7=' + this.keyword);//统计-无结果
				}

				$(window).scrollTop(0);
			}
			else
			{
				alert(result.msg || "服务器错误");
			}
		});
	}
});
//路由
window.ebookweb.Router = Backbone.Router.extend({
	routes:{
		//路径
		"":"main",
		"close":"close",
		"main/:tab":"mainTab",
		"books/:type/:title":"bookList",
		"books/:type/:title/:cateId":"bookList",
		"books/:type/:title/:cateId/:cateName":"bookList",
		"books/:type/:title/:cateId/:cateName/:statP5":"bookList",
		"books/:type/:title/:cateId/:cateName/:statP5/:statP6":"bookList",
		"search":"search",
		"search/":"search",
		"search/:keyword":"search",
		"latest-readed":"lastestReaded",
		"ranks/:rankid/:rankname":"rankList",
		"book/detail/:bookid/:title":"bookDetail",
		"book/catalog/:bookid":"bookCatalog"
	},
	close:function(e){
		//关闭webview
		console.log("关闭web");
		if(window.splash) window.splash.onBackPressed(true);//退出当前webview

		return false;
	},
	main:function(){
		//首页
		console.log("去首页");
		window.ebookweb.mediator.trigger(window.ebookweb.events.GO_TO_MAIN_PAGE_EVENT);
	},
	mainTab:function(tab){
		//去首页的标签页面
		window.ebookweb.mediator.trigger(window.ebookweb.events.CHANGE_MAIN_PAGE_TAB_EVENT,tab);
	},
	lastestReaded:function(){
		//去最近阅读
		console.log("去最近阅读页面");

		var data = new window.ebookweb.models.PageViewModel({
		});
		var page = new window.ebookweb.views.pages.LastReadPageView({model:data});
		window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
	},
	loadGlobalData:function(callback)
	{
		//获取全局数据,暂时解决办法
		$.ajax({
			url:window.ebookweb.config.api_host+"index",
			method:"get",
			data:null,
			dataType:"json",
			context:this
		}).always(function(result){
			//结果,目前返回是一个数据对象,之后加上错误码判断
			window.ebookweb.data.GlobalData["main"] = result;
			if(callback) callback();
		});
	},
	bookList:function(type,title,cateId,cateName,stat_p5,stat_p6){
		//首页-精选
		var page_uuid = type+"_"+title+"_"+cateId+"_"+cateName+"_"+stat_p5+"_"+stat_p6;
		
		console.log("去书籍列表页面,page_uuid=",page_uuid,"p5=",stat_p5,"p6=",stat_p6,type);

		console.log(this["bookListPageId"] || "无this['bookListPageId']");

		if(this["bookListPageId"] && page_uuid == this["bookListPageId"])
		{
			//缓存的上一相同的页面
			console.log("相同的页面");

			var page = this.bookListPage;
			window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
			return;
		}

		this["bookListPageId"] = page_uuid;

		var data;
		switch(type)
		{
			case "recommend"://重磅推荐
				if(window.ebookweb.data.GlobalData["main"]&&window.ebookweb.data.GlobalData["main"]["emphasis"])
				{
					var books = window.ebookweb.data.GlobalData["main"]["emphasis"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});
				}
				else
				{
					this.loadGlobalData(function(){
						var books = window.ebookweb.data.GlobalData["main"]["emphasis"];
						data = new window.ebookweb.models.PageViewModel({
							title:title,
							pageid:"recommend",
							autoLoad:false,
							data:books,
							stat_p5:stat_p5
						});

						var page = new window.ebookweb.views.pages.BookListPageView({model:data});
						window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
					});
				}
			break;
			case "xiaobian"://小编懂你
				if(window.ebookweb.data.GlobalData["main"]&&window.ebookweb.data.GlobalData["main"]["xiaobian"])
				{
					var books = window.ebookweb.data.GlobalData["main"]["xiaobian"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});
				}
				else
				{
					this.loadGlobalData(function(){
						var books = window.ebookweb.data.GlobalData["main"]["xiaobian"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});

						var page = new window.ebookweb.views.pages.BookListPageView({model:data});
						window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
					});
				}
			break;
			case "men"://男生爱看
				if(window.ebookweb.data.GlobalData["main"]&&window.ebookweb.data.GlobalData["main"]["men"])
				{
					var books = window.ebookweb.data.GlobalData["main"]["men"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});
				}
				else
				{
					this.loadGlobalData(function(){
						var books = window.ebookweb.data.GlobalData["main"]["men"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});

						var page = new window.ebookweb.views.pages.BookListPageView({model:data});
						window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
					});
				}
			break;
			case "women"://女生爱看
				if(window.ebookweb.data.GlobalData["main"]&&window.ebookweb.data.GlobalData["main"]["women"])
				{
					var books = window.ebookweb.data.GlobalData["main"]["women"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});
				}
				else
				{
					this.loadGlobalData(function(){
						var books = window.ebookweb.data.GlobalData["main"]["women"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});

						var page = new window.ebookweb.views.pages.BookListPageView({model:data});
						window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
					});
				}
			break;
			case "newbook"://新书首发
				if(window.ebookweb.data.GlobalData["main"]&&window.ebookweb.data.GlobalData["main"]["newBook"])
				{
					var books = window.ebookweb.data.GlobalData["main"]["newBook"];
					data = new window.ebookweb.models.PageViewModel({
						title:title,
						pageid:"recommend",
						autoLoad:false,
						data:books,
						stat_p5:stat_p5
					});
				}
				else
				{
					this.loadGlobalData(function(){
						var books = window.ebookweb.data.GlobalData["main"]["newBook"];
						data = new window.ebookweb.models.PageViewModel({
							title:title,
							pageid:"recommend",
							autoLoad:false,
							data:books,
							stat_p5:stat_p5
						});

						var page = new window.ebookweb.views.pages.BookListPageView({model:data});
						window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
					});
				}
			break;
			case "authorbooks"://作者还写过
				data = new window.ebookweb.models.PageViewModel({
					title:title,
					pageid:"authorbooks",
					autoLoad:true,
					autoLoadURL:window.ebookweb.config.api_host+"book/books-by-author?authorid="+cateId,
					data:null,
					stat_p5:stat_p5
				});
			break;
			default:
				data = new window.ebookweb.models.PageViewModel({
					title:title,
					pageid:"recommend",
					autoLoad:true,
					autoLoadURL:window.ebookweb.config.api_host+"category?id="+cateId+"&type=week",
					data:books,
					stat_p5:stat_p5,
					stat_p6:stat_p6
				});
			break;
		}

		if(!data) return;

		console.log("data:",data.toJSON());

		var page = this.bookListPage = new window.ebookweb.views.pages.BookListPageView({model:data});
		window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);

		page.delegateEvents(page.events);
	},
	rankList:function(rankId,rankName)
	{
		//去排行榜列表
		console.log("去排行榜列表:",rankId,rankName);

		var data = new window.ebookweb.models.PageViewModel({
			title:rankName,
			pageid:"ranks",
			rankId:rankId,
			rankName:rankName,
			autoLoad:true,
			autoLoadURL:window.ebookweb.config.api_host+"duration?id="+rankId
		});
		var page = new window.ebookweb.views.pages.RankListPageView({model:data});
		window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);

		//统计
	},
	search:function(keyword){
		//搜索页面
		console.log("去搜索页面");

		if(window.ebookweb.data.GlobalData["main"]&&window.ebookweb.data.GlobalData["main"]["hotBook"])
		{
			var books = window.ebookweb.data.GlobalData["main"]["hotBook"];
			var data = {
				pageid:"search",
				data:{
					keyword:keyword,
					recommend:window.ebookweb.data.GlobalData["main"]["searchRecommend"],
					hotBook:window.ebookweb.data.GlobalData["main"]["hotBook"],
					history:new window.ebookweb.models.SearchHistoryList()
				}
			};
			var page = new window.ebookweb.views.pages.SearchPage({model:new window.ebookweb.models.PageViewModel(data)});
			window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
		}
		else
		{
			this.loadGlobalData(function(){
				var books = window.ebookweb.data.GlobalData["main"]["hotBook"];
				var data = {
					pageid:"search",
					data:{
						keyword:keyword,
						recommend:window.ebookweb.data.GlobalData["main"]["searchRecommend"],
						hotBook:window.ebookweb.data.GlobalData["main"]["hotBook"],
						history:new window.ebookweb.models.SearchHistoryList()
					}
				};
				var page = new window.ebookweb.views.pages.SearchPage({model:new window.ebookweb.models.PageViewModel(data)});
				window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
			});
		}
	},
	bookDetail:function(bookid,title){
		console.log("去书籍详情页面",bookid,title);
		//
		var data = new window.ebookweb.models.PageViewModel({
			title:title,
			bookid:bookid,
			catalog:null,
			authorBooks:null,
			readerBooks:null
		});
		var page = new window.ebookweb.views.pages.BookDetailPageView({model:data});
		window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
	},
	bookCatalog:function(bookid){
		console.log("去书籍目录页面",bookid);
		var data = new window.ebookweb.models.PageViewModel({
			title:"目录",
			bookid:bookid,
			catalog:null,
			authorBooks:null,
			readerBooks:null
		});
		var page = new window.ebookweb.views.pages.BookCatalogPageView({model:data});
		window.ebookweb.mediator.trigger(window.ebookweb.events.POPUP_PAGE_EVENT,page);
	}
});
/**
*	开始工作
*/

$(function(){
	//实例化
	var appView = new window.ebookweb.views.AppView({model:new window.ebookweb.models.AppModel()});//主应用
	var router = new window.ebookweb.Router();//路由

	//路由开始
	var history = Backbone.history.start();
	console.log("history:",history);
});